import chalk from 'chalk';
import path from 'path';
import { promises as fs } from 'fs';
import { collectFiles } from '../../utils/codebase.js';

const SOURCE_EXTENSIONS = ['.ts', '.tsx', '.js', '.jsx', '.mjs', '.cjs'];

type Rule = {
  regex: RegExp;
  message: string;
};

const RULES: Rule[] = [
  { regex: /\beval\s*\(/g, message: 'Use of eval detected.' },
  { regex: /new Function\s*\(/g, message: 'Dynamic Function constructor detected.' },
  { regex: /child_process\.(exec|spawn|execSync|spawnSync)/g, message: 'Child process invocation detected.' },
  { regex: /require\(['"]child_process['"]\)/g, message: 'child_process module imported.' },
  { regex: /crypto\.createHash\(['"]md5['"]\)/gi, message: 'MD5 hashing algorithm in use.' },
  { regex: /crypto\.createHash\(['"]sha1['"]\)/gi, message: 'SHA1 hashing algorithm in use.' },
  { regex: /rejectUnauthorized\s*:\s*false/g, message: 'TLS certificate validation disabled.' },
  { regex: /\.innerHTML\s*=/g, message: 'innerHTML assignment detected (potential XSS).' },
  { regex: /password\s*[:=]\s*['"].+['"]/gi, message: 'Hardcoded password assignment.' },
  { regex: /\/\/\s*TODO:\s*Security/gi, message: 'Security TODO left in code.' },
];

export async function run(targetDir = process.cwd()): Promise<void> {
  console.log(chalk.blue('ðŸ§© Scanning code for vulnerabilities...'));
  const files = await collectFiles(targetDir, { extensions: SOURCE_EXTENSIONS });
  if (files.length === 0) {
    console.log(chalk.yellow('No source files to scan for vulnerabilities.'));
    return;
  }

  const findings: string[] = [];
  for (const file of files) {
    let content: string;
    try {
      content = await fs.readFile(file, 'utf-8');
    } catch {
      continue;
    }
    RULES.forEach((rule) => {
      rule.regex.lastIndex = 0;
      if (rule.regex.test(content)) {
        findings.push(`${path.relative(targetDir, file)} -> ${rule.message}`);
      }
    });
  }

  if (findings.length === 0) {
    console.log(chalk.green('No obvious insecure patterns detected.'));
    return;
  }

  console.log(chalk.yellow(`Detected ${findings.length} potential issues:`));
  findings.slice(0, 20).forEach((finding) => console.log(`- ${finding}`));
  if (findings.length > 20) {
    console.log(`...and ${findings.length - 20} more findings.`);
  }
}
