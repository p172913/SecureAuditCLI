import chalk from 'chalk';
import { execAsync } from '../../exec.js';

/**
 * Scan a file for malware using ClamAV and optionally YARA (if rules.yar present)
 * @param file Path to file
 */
export async function run(file: string) {
  if (!file) {
    throw new Error('scanMalware.run: file argument required');
  }
  console.log(chalk.blueBright(`ðŸ¦  [Malware] Scanning: ${file}`));
  const clam = await execAsync(`clamscan "${file}"`);
  console.log(chalk.cyan('\n=== ClamAV Scan ==='));  
  if (clam.code !== 0) {
    if (clam.stderr) {
      console.error(chalk.red(clam.stderr));
    } else {
      console.error(chalk.red(clam.stdout));
    }
  } else {
    console.log(clam.stdout);
  }

  // Try YARA rules, skip error if not present
  const yara = await execAsync(`yara rules.yar "${file}"`);
  console.log(chalk.cyan('\n=== YARA Scan ==='));
  if (yara.code !== 0) {
    if (yara.stderr.includes('No such file or directory') || yara.stderr.includes('Rules file not found')) {
      console.warn(chalk.yellow('YARA rules.yar not found; skipping YARA scan.'));
    } else {
      console.error(chalk.red(yara.stderr || yara.stdout));
    }
  } else {
    console.log(yara.stdout);
  }
}
